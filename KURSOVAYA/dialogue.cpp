#pragma once
#include <iostream>
#include <string>
#include <fstream>
#include "Windows.h"
#include "dialogue.h"
#include "level.h"
#include "services.h"
#include "bow.h"

using namespace std;

DialogueObject Dialogue::current_object = DialogueObject::princess;

void Dialogue::loop() {
	clear_all();
	bool can_talk_with_princess = true;

	while (true) {
		if (GetAsyncKeyState(VK_ESCAPE) & 0x8000) {
			beautiful_clear_all();
			// Ждем чтобы случайно не затригерить выход из основного цикла
			Sleep(100);
			break;
		}

		// Чиним если был выход из полноэкранного режима
		if (!check_console_size_changes()) {
			clear_all();
		}

		if (current_object == DialogueObject::princess) {
			if (check_right_left_buttons()) {
				current_object = DialogueObject::blacksmith;
				beautiful_clear_all();
			}
			else {
				process_princess();
			}
		}
		else if (current_object == DialogueObject::blacksmith) {
			if (check_right_left_buttons()) {
				current_object = DialogueObject::princess;
				beautiful_clear_all();
			}
			else {
				process_blacksmith();
			}
		}
		Sleep(15);
	}
}

void Dialogue::print_dialogue_frame(const string& text, const string& heading) {
	set_text_color("green");
	move_cursor((get_console_width() - get_first_line_width(text) - heading.length()) / 2 + get_first_line_width(text) + 2);
	cout << heading;

	set_text_color("purple");
	clear(get_first_line_width(text) + 1, 1, get_console_width() - get_first_line_width(text) - 1, '_');
	clear(get_first_line_width(text) + 2, get_console_height() - 1, get_console_width() - get_first_line_width(text) - 3, '_');

	for (int i{ 2 }; i < get_console_height(); i++) {
		move_cursor(get_first_line_width(text) + 1, i);
		cout << '|';
		move_cursor(get_console_width() - 1, i);
		cout << '|';
	}

	set_color();
}

void Dialogue::process_princess() {
	print_dialogue_frame(princess, "Принцесса");
	move_cursor();
	cout << princess;

	string word = "";
	bool run = true;
	for (int i{ 0 }, new_strings_cout{ 0 }; i < 6 && run; i++) {
		cout << word;
		word = "";
		if (i != 0) Sleep(1000);
		move_cursor(get_first_line_width(princess) + 4, 3 + i * 2 + new_strings_cout);
		for (char symbol : princess_dialogues[Level::get_current_level() - 2][i]) {
			if (check_right_left_buttons()) {
				current_object = DialogueObject::blacksmith;
				beautiful_clear_all();
				run = false;
				break;
			}
			word += symbol;
			if (get_cursor_x() + word.length() >= get_console_width() - 1 || symbol == '\n') {
				new_strings_cout++;
				move_cursor(get_first_line_width(princess) + 4 + 1, 3 + i * 2 + new_strings_cout);
			}
			if (symbol == ' ' || symbol == '\0') {
				Sleep(100);
				cout << word;
				word = "";
			}
		}
	}
	Sleep(50);
	cout << word;
	word = "";
}

void Dialogue::process_blacksmith() {
	print_dialogue_frame(blacksmith, "Кузнец");
	move_cursor();
	cout << blacksmith;

	set_text_color("yellow");
	move_cursor(get_console_width() - 6, 3);
	cout << get_current_money();
	//set_color();

	set_text_color("green");
	move_cursor(get_first_line_width(blacksmith) + 6, 5);
	cout << "->";

	// Можно изменить фон выбранного элемента
	string bg_color = "black";

	move_cursor(get_first_line_width(blacksmith) + 8, 5);
	set_color("white", bg_color);
	cout << "Увеличение урона лука (";
	set_color("red", bg_color);
	cout << Arrow::get_bow_level();
	set_color("white", bg_color);
	cout << "->";
	set_color("green", bg_color);
	cout << Arrow::get_bow_level() + 1;
	set_color("white", bg_color);
	cout << ')';
	set_bg_color(bg_color);
	// Так как идея врядли будет применятся изза не подходящих цветов консоли цикл сделан с костылями
	//for (int i{ 0 }; i < get_console_width() - 12 - (get_first_line_width(blacksmith) + 8) - 28; i++) {
	//	cout << ' ';
	//}
	move_cursor(get_console_width() - 12, 5);
	if (get_current_money() < 50) {
		set_color("red", bg_color);
	}
	else {
		set_color("green", bg_color);
	}
	cout << 50;
	set_color();

	// Так как в магазине только 1 товар можно пока что сделать логику только для его покупки
	if (GetAsyncKeyState(VK_RETURN) & 0x8000 && get_current_money() >= 50) {
		Arrow::level_up();
		Dialogue::money_up(-50);
	}
	set_color();
}

int Dialogue::get_current_money() {
	int level = 0;
	fstream file("money.txt", ios::in);
	if (file.is_open()) {
		file >> level;
		file.close();
	}
	else {
		set_new_money(level);
	}
	return level;
}

void Dialogue::money_up(const int points) {
	int current_level = get_current_money();
	fstream file("money.txt", ios::out | ios::trunc);
	if (file.is_open()) {
		file << current_level + points;
		file.close();
	}
}

void Dialogue::set_new_money(const int new_level) {
	fstream file("money.txt", ios::out);
	if (file.is_open()) {
		file << new_level;
		file.close();
	}
}


const string Dialogue::princess_dialogues[Level::max_level][6] = {
	{
		"Принцесса: Кто ты? Как кто-то смог пройти через все эти ужасы?",
		"Рыцарь: Я — рыцарь. Я пришёл, чтобы победить чудовищ. И найти способ освободить тебя.",
		"Принцесса: Ты пришёл… ради меня? Но ты не знаешь ничего об этом месте.",
		"Рыцарь: Я не боюсь. И я узнаю все. Я не покину тебя.",
		"Принцесса: Ты — первый, кто смог пройти через замок. Ты… правда хочешь помочь?",
		"Рыцарь: Я дам всё, чтобы увидеть тебя свободной."
	},
	{
		"Принцесса: Ты действительно не боишься этого места?",
		"Рыцарь: Я был на поле боя, где страшнее. Эти чудовища — лишь пустые оболочки.",
		"Принцесса: Ты храбр, но здесь не всё так просто. Это место полнится магией, которая связывает меня с ним.",
		"Рыцарь: Я уверен, что смогу найти способ освободить тебя. Ты не должна оставаться здесь.",
		"Принцесса: Ты не понимаешь… Я не могу покинуть этот замок. Я… я стала его частью."
	},
	{
		"Рыцарь: Ты говоришь, что замок держит тебя. Что именно это значит? Почему ты не можешь просто уйти?",
		"Принцесса: Это проклятие. Я открыла двери, когда не должна была, и теперь эта магия держит меня здесь. Я не могу уйти без разрушения всего.",
		"Рыцарь: Но ты ведь не виновата в этом, верно? Ты не знала, что произойдёт.",
		"Принцесса: Возможно. Но теперь я здесь, и этот замок стал моим пленом. Я не могу изменить то, что случилось.",
		"Рыцарь: Я освобожу тебя, как только разберусь с этим проклятием. Мы найдём выход.",
		"Принцесса: Ты… надеешься? Ты веришь, что можно изменить судьбу?"
	},
	{
		"Рыцарь: Каждый раз, когда я иду вглубь замка, я чувствую, что проклятие ослабевает. Это моя сила или твоя?",
		"Принцесса: Это твоя сила. Ты не только сражаешься с чудовищами, ты разрушаешь их связь с этим местом. Ты… меняешь атмосферу.",
		"Рыцарь: Если я смогу уничтожить всех врагов, ты сможешь уйти?",
		"Принцесса: Это не так просто. Проклятие не зависит от чудовищ. Оно связано с самой магией замка, с тем, что я сделала.",
		"Рыцарь: Тогда я буду сражаться дальше. Всё это не зря.",
		"Принцесса: Ты веришь в то, что я могу быть свободной? Это многое значит."
	},
	{
		"Принцесса: Ты снова вернулся. Я начинаю думать, что ты не просто пришёл за моим спасением.",
		"Рыцарь: Я пришёл, чтобы освободить тебя. Но я не могу скрыть, что каждый раз мне становится всё легче с тобой говорить.",
		"Принцесса: Ты ведь не просто рыцарь. Ты... не такой, как другие.",
		"Рыцарь: Я был тем, кто сражался за людей. Но сейчас я сражаюсь за тебя. Ты не должна быть в этом замке.",
		"Принцесса: Я хочу верить в твою силу. Но я… не уверена, что смогу покинуть это место.",
		"Рыцарь: Ты будешь свободна. Это моя цель."
	},
	{
		"Принцесса: Ты продолжаешь двигаться вперёд, несмотря на всё. Я чувствую, как меняется атмосфера. Ты действительно можешь освободить меня.",
		"Рыцарь: С каждым твоим словом я чувствую, как я приближаюсь к цели. Ты не будешь больше здесь.",
		"Принцесса: Я не знаю, смогу ли я выбраться. Это место стало моим домом. Я связана с ним.",
		"Рыцарь: Но дом — это не стены и не проклятие. Дом — это свобода. Я тебе помогу.",
		"Принцесса: Ты — мой единственный шанс. Я не могу отказать в этой надежде."
	},
	{
		"Рыцарь: Я почти закончил. Почти победил всех чудовищ. Но что будет, если я освобожу тебя?",
		"Принцесса: Ты задаёшь странные вопросы. Ты же пришёл, чтобы разрушить проклятие!",
		"Рыцарь: Я разрушу его. Но и ты должна быть готова к тому, что освободиться не так просто.",
		"Принцесса: Я готова. Если ты победишь всё, что здесь осталось, я буду свободна.",
		"Рыцарь: И мы будем идти вместе. Никаких преград. Ты больше не будешь одна.",
		"Принцесса: Я не помню, когда в последний раз я чувствовала, что не одна."
	},
	{
		"Рыцарь: Ты говорила о том, как открыла дверь. Как думаешь, сможем ли мы закрыть её?",
		"Принцесса: Магия замка не так проста. Но ты — первая надежда. Возможно, ты и есть тот, кто должен закрыть её.",
		"Рыцарь: Я не боюсь. Я пройду этот путь, чтобы ты была свободна.",
		"Принцесса: Я верю в тебя. Я верю в то, что ты сможешь это сделать. Иначе… я не смогла бы продолжать."
	},
	{
		"Рыцарь: Я почти на финишной прямой. Эти чудовища больше не станут мне помехой. Но ты… ты не боишься того, что будет после?",
		"Принцесса: Я не боюсь. Я просто хочу быть свободной. Ты сделал для меня больше, чем любой другой.",
		"Рыцарь: Тебе не нужно будет бояться. Ты будешь со мной.",
		"Принцесса: Я надеюсь на это. Ты — всё, что у меня есть."
	},
	{
		"Рыцарь: Всё закончено. Замок очищен. Проклятие разрушено. Ты свободна.",
		"Принцесса: Ты сделал невозможное. Ты освободил меня.",
		"Рыцарь: Ты не одна. И никогда больше не будешь.",
		"Принцесса: Ты показал мне, что значит настоящая сила — не в мечах, а в вере. Спасибо, рыцарь.",
		"Принцесса: Ты не просто освободил меня. Ты освободил нас обоих."
	}
};

string Dialogue::princess =
R"(++++********######%%%%%%@@@@@@@@@@@@@@@@@@@*@@@@@@@@@@@@@@@@@@@@@%%######*****++++++
++++*******######%%%%%%@@@@@@@@@@@@@@@@@@@@##@@@@@@@@@@@@@@@@@@@@%%%######*****+++++
++++*******#####%%%%%@@@@@@@@@@@@@@@@@@@@+%@%@@@@@@@@@@@@@@@@@@@@@%%%#####*****+++++
++++*******####%%%%%@@@@@@@@@@@@@@@@@@@%%+%+=@%#@@@@@@@@@@@@@@@@@@%%%#####*****+++++
+++++*****#####%%%%@@@@@@@@@@@@@#@@@%@@*%@@%==+@***+@*@@@@@@@@@@@@%%%######****++++=
++++++****####%%%%%@@@@@@@@@@@@+@@@@@@@*@@@%=++##@@++@++*@%*@@@@@@@%%%####*****++++=
=++++++****###%%%%%@@@@@@*@@#@#@@@+*+@=*%@%+=-=##==%=*%+@+#=@@@@@@@%%%%###******+++=
=+++++++***###%%%%%%@@@@@%@=+==%*@+**@++@+@=%=@@=*#*-##==*#+*@@@@@%%%%%###******+++=
==++++++***####%%%%%@#@@@#%@***#=@=@=@@@@@@@@@@#-=##+-%-#@*-**@@@@@%%%%####*****++++
===++++++**####%%%%%@#@*@#-#%%=@%+--===----*+@@#+=--+%=-==-=*%+#+=@%%%%%###****++++=
===++++++**####%%%%%@%@%#+@@*-+*@@%*++==-=++#@@%*#**+----==*==-++@@%%%%####****++++=
===++++++**####%%%%%@*%=#*-**#@@@@*#+===-=+#@@@@%*+*++++=--:**-=#*@%%%%####****++++=
===+++++***####%%%%@=-%#****##@@@@@+*===*++**#@%%#**+=+=====-:+-+-+%%%%###*****++++=
===++++****####%%%%%--**++%*#%@@%=###+@@@@@*#*@@%**+++++===-----:--*%%%###****++++==
===++++****###%%%%@@#===+*+%##=%@@+%@@@@@@@@@%###***++==+=-++---=-==+%###*****++++==
====+++****####%%@@@#%%*+*+=*##=#@@@@@@@@@@@@@@%***=+=#+==+=+=====-+=%####***+++====
====+++*****####%@%%=%#*-++*@++*@@@@@@@@@@@@@@@@@%*#%+-==*+=*===-=+-++####***+++====
=====++******###%@@+#@##+#=+++@@@@@@@@@@@@@@@@@@@@@@*#*#==-*=====--==*####**++++====
=====+++******##@%%*@++=+==+*@@@@@@@@@@@@@@@@@@@@@@@@@#**+*==+====--+=####***++++===
=====+++*******####=----=+-*@@##@%@@@@@@@@@@@@@@@@@@#*++%*=+**=--++---###****++++===
=====+++++*****###=%===#-=#+@@@@%%#+++#@@@@@@@@#+++*%%##%%=*-=-----+-+###****+++++==
======++++++******#+*++=-=%#*-=-:-+:*%@@@@@@@@%%#*-=-:-:-++*+-=---==#####****+++++==
========++++*******+#++--#%-::+-@----*%%@@@@@%##*::@:--*:::=*--===--####*****++++++=
=========+++++++***%-+#+=%%%*+@-%@%*@+@@@@@@@##@=@=#@@=@+=***==+*+--###******+++++==
=========+++++++***#*%@+*@%%@#%#@@@@@@@@@@@@@%%@@@@@@@++##***+==+::-=##*****+++++===
=========++++++++*%**-=@@+%%@@@@@@@@@@@@@@@@@@@@@@@@@@@%%#***=**:::-==#****+++++====
=========++++++++%*%%+--@%@%%@@@@@@@@@@@@@@@@@@@@@@@@@@%##*#*=#::--:--****++++++====
=========+++++++#++%%*=-::+@%%@@@@@@@@@@@@@@%%@@@@@@@@%##***:=::---:-==***+++++=====
=========+++++++++##**=-%*:@%%@@@@@@@@@@%@#*-##@@@@@@%%#**#::*::----:--+**+++++=====
==========+++++++#@%*++=-::@@@@@@@@@@@@@@@%##%@@@@@@@%%###*::=:-------==**+++++=====
===========+++++**=*--+@@*#:@@@@@@@@@@@@@@@@@@@@@@@@@%###%::#++----=---=**#++++=====
============++@+++*-=++@=%-::@@@@@@@@@@#++++=+*%@@@@%%###::=*%%-=---=--=**+*+++=====
============+@+++===-##+*=::::@@@@@@@@@%@@@@#**@@@%%%###:::::+--=---:---+*+++++=====
============#++++===-%#*=-:-::::@%@@@@@@@#***#%@@%%##%:::::::*----+::-====+++++=====
=============++++**--##+-----::::=*%@@@@@@@@@@@@%##==::::::-:-----::-:=++===++++====
=============++*%+++-+*=--+-:-:::-+++%@@@@@@@@%#%====:::::-----=::---:-======++++===
============+=@@%%+=--==-#=---::::***+++%%###%===++==:::::--+*=::-==-:---======+====
============@**@%*=-*--+#%*--::::-*#%##**++++++++++==-::::-=+*++-=+--:----====-=+===
====-=======#%#**=-*%+==+==-:::::*#%%%%%##**++++**++==:::::-**++==---:-----=-=--=+==
==========**#*+=---#*-===::::-::+#%%@@@@%%%#####***+++=@:::-=====-=:=:-------=--=+==
==========+*=+==--:*%%=::-----:**#%%@@@@@@%%%%%%#****+=*=-:--:==---+=------------===
-=-===+===*+==-----*%%*+====--=+=%@@@@@@@@@%%%@@####*#++++===-::--++--------+#%@@@@@
--=@@@@@@%%*==----:+*#*+*+=--=+#%%@@@@@@@@@@@@@@@%**+##***+=*+=--%#==--:--*#%@@*#@@@
--%@@@%@@@@@*----::=**++===-+*#%%%@@*+@%%@@@@*@*%#*%%%%%%%#=+**+*#%=-:::+*#%@@@@@@@#
--@@@@@@@@%##+=---++-=+==--+*%@@@@@@@@@@@@@%@@@@@@@@@@@@@%%%+*+=+-----=+*@@++#@@@@@@
-=@@@@@@##+@@@#+=+=**--==---*%@@@@@@@@@@@%@++@@@@@@@@@@@@@%%+-+=--+==--+#@@@@%#%@@@@)";

string Dialogue::blacksmith =
R"(-:::::::::::::::::::::::::::::::----------------------------------::::--::::::::::::
:-::::::::::::::::::::::::::::::-------------------::-=-----------:::::::::::-::::::
::-:-:::::::::::::::::::::::-:--------------------:----=-===------::::::-:::-:-::--:
:-::-:::::::::::::::::::::::--------------------------======-----:::::::::::::::::::
::::::::::::::::::::-:::::::---------@@@@@@%+==------========-==----::::-:::::::-::-
::::-::-::::--:::::::::-:---------@@##@@@%##*==+=----=======-===-=-:-::::::::::::-:-
:-::::---:::::::::-::------------#@@%@@@@@@%*+--================----:::::::::::-::::
---:::---::::::::::-:-:------=-=@@@@%%@@@%###+--=++===============--::::::::-::::-::
-:-:::---:::-:::---:-----------#%%*%@@@=+***====-==========@+=====---:::------::-:-:
-:------:::::----:------------=@+*@%#@#+-#@:-:--===-======@@@%@%%===---:-----::-:::-
-::-:----:::::-::-::-:--------*@@#@@*##@*#@-=+=-+=--=====@#@*@@%%#%#*---------::----
:-:::-----:--::::------------+@@@@@@@@#+@@+===-====-====@@@@@@@%@@%#%#+*=---:::---:-
:-::----:----:---::::--------:#@@@@@@@@@+=-%+@@++==-===@@@@@@@@@@@@%%%**====+*--:---
-::-=-=---:-::-:--:-----:-----@@%@@@@@%*#@@@@+*+#*@-===-:-@@@=@@@@@@@%+*+#=+==-=::::
::---=-----=+----:------:--=--=*+@@@@@@@@@@@%%%%@@======::::::@@@@%%#+++======:::-::
:-----=-------=-------------+=+**@%@@@@@@@@@@@#%@%#%=====::::-::::#@%*+=*====-::::::
:------+----------:-----:@@@*=+#+@@@@@@@@@@@@@@@@%---======:::::=%%::::#==++::::::=:
::---==+==---=:=::---=@@@@@@@@=#**#=@@@@@@@@@@%@%%*-:--=========@%=--:::::--::::::::
::-:==+==+---=------@@@@@@@@@*@-@%#*=%%@@@@#@##@@==-:----======%*=-:::::::::----:-:-
----==+=+==--::::-%@@@@@@@@@@%@@**+*++++=@@+#***%----:----====##=-::---:::::::::::::
:-----===-----:--:@@@@@@@@@@@%@@*=+-=++*==*%++%*=---:--+---+%#*=::-:-----:-::-:::::-
::----=+=--------@@@@@@@@@@%@@@@@=++==++=++=*#**===----:==-*%*+-:=---------=::::-::-
:--::-::-------:@@@@@@@@@@@@@@#%%#+--++++=-++#+##==---:--=+%#+--===-----------:-:---
-:=-==---=-----@@@@@@@@@@@@@%@@@*@--++*==+==----::=:::---+##+-:====--------=----:-:-
-=--::::::-:---@@@@@@@@@@@@@@+@%+==%=--+++===-----::-:-*@+#*-::-=-----==-=-:-----+:-
-:-:::::::::=:#@@@@@@@@@@@@@++@%+#+++=#=====----------=@%#*==----=--====---=----=:=-
-:-::-:--:::--@@@@@@@%%%%@*#=@@#@==*+++++++===--:----#*@@@*=-------======---=-----:-
--:::::-::::-#@@@%%@@@@@++++=@@#@=++++*+++===-------#%+%%#=+----:----=-====+----:::-
:::::-:-=--::@%@@@%@*@#%#+=-=@%@++++*+++=====------@@*=-+=+*=----:---======-==--::--
-:::::--:::-@@@@#@@@@@=###*:%#+%==+++++======----##@*=-:-=--:---=---===+===-----:::-
-::------=---@@@@@+*@@@@%%#%##+====++++==-=-----%##==-::-:-:-:-:----==++=+=------:--
::::------:--+@+#-%%%#%@%@@@@@@%%#%#*+*+=#%###%+%#+--::-::::-::-----===@%-=--:---:-:
::::-:------:----=+***####%#%@@%%%@%%%#%@@@@@#+=+**-::-:::::-::----==--==-==::--:---
::::-:----=::-:*----==*++++**+**+**%##%%#%@@%=-=----:-::-::::::::--=-===*----::::---
-:::::=-:--::::-------=======++==*===+*%*%%*====---::::::::-:-=-=--==--==---:-------
--::::-*---:::---=---------:::---:----:+=*++-===-::::::::::-----==+==--===:-:--:::--
-:::::--:-::::-:----=------=-:--====-----@#=::-:::::::::::--=--===+++-----::----:---
--::-:-::-::::------------+-+-=-====-=-*#%%-::::::::::::-::----=====+=-----:::------
-::::-:-----==----------=++-#=-*#-::--##@*=:::::::::::::::------=+---::--:-----:----
--:--:==-:==----=---==--=++-==+#=:+::-=-*+-:::::::::-::::-::-===-=-=::-:+=--:--:==--
--===+-=-====-=--==---=--=+-+=++#::--=--:=::::-::::::::::::::-----==----:--:-:-:::--
=-:-------::::::::::-:--+*=-=+===:#@@%#==#:::::-::::::-::::::-----=-----:--:::-:::::
--------::::-:---:::--=-===--=+=+*+=@#*#=---::::=::::-::::::-:----------:----:::-:::
:-:------:-=*-::::-::--*--+:-=+==+==*++++=---::-+==-:::-::::-:----------:---::::::::
::-:-*=--::::::::::=-===+---:=--===+++=====--=---=#=::::::::-::-:--------:--::::::::
:-:::--------::::::---+=:-::+==:====+++=-=-=-----:::::::::-:::=:::-:::::::::::::::::)";
